STEP 1 â€” Launch Ubuntu Server (EC2)

Go to AWS Console â†’ EC2 â†’ Launch Instance

Recommended:

AMI â†’ Ubuntu 22.04 LTS

Instance Type â†’ t3.medium (minimum)

Storage â†’ 20GB+

Key Pair â†’ Create or use existing

Security Group:

SSH (22) â†’ Your IP

Outbound â†’ Allow All

Click Launch Instance

âœ… STEP 2 â€” Connect to Server

From your local machine:

ssh -i your-key.pem ubuntu@<EC2-PUBLIC-IP>
âœ… STEP 3 â€” Update Server
sudo apt update -y
sudo apt upgrade -y
âœ… STEP 4 â€” Install Required Tools
ðŸ”¹ Install Git
sudo apt install git -y
ðŸ”¹ Install AWS CLI
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
sudo apt install unzip -y
unzip awscliv2.zip
sudo ./aws/install

Verify:

aws --version
ðŸ”¹ Install Terraform
wget https://releases.hashicorp.com/terraform/1.8.5/terraform_1.8.5_linux_amd64.zip
unzip terraform_1.8.5_linux_amd64.zip
sudo mv terraform /usr/local/bin/

Verify:

terraform version


STEP 5 â€” Install GitHub Self-Hosted Runner

STEP 6 â€” Configure Runner (IMPORTANT)

STEP 7 â€” Install Runner as Background Service
sudo ./svc.sh install
sudo ./svc.sh start

Check status:

sudo ./svc.sh status

Enable on reboot:

sudo systemctl enable actions.runner.*



STEP 1 - Create GitHub OIDC Provider in AWS

AWS Console â†’ IAM â†’ Identity providers â†’ Add provider

Provider type: OpenID Connect

Provider URL: https://token.actions.githubusercontent.com

Audience: sts.amazonaws.com


Create IAM Role for Self-Hosted Runner (OIDC Role)


STEP 2 â€” Create IAM Role for Self-Hosted Runner (OIDC Role)

Go to:
IAM â†’ Roles â†’ Create role

Choose:
Web Identity

Select:
token.actions.githubusercontent.com
Audience: sts.amazonaws.com

Attach Permissions (Example)

Since you are using Terraform + EKS:
AmazonEKSClusterPolicy
AmazonEC2FullAccess
IAMFullAccess
AmazonS3FullAccess
AmazonDynamoDBFullAccess


Name role:

github-oidc-selfhosted-role
Create role.

STEP 3 â€” Edit Trust Policy (VERY IMPORTANT)

Open role â†’ Trust relationships â†’ Edit

Replace with:

{
 "Version": "2012-10-17",
 "Statement": [
  {
   "Effect": "Allow",
   "Principal": {
     "Federated": "arn:aws:iam::<ACCOUNT_ID>:oidc-provider/token.actions.githubusercontent.com"
   },
   "Action": "sts:AssumeRoleWithWebIdentity",
   "Condition": {
     "StringEquals": {
       "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
     },
     "StringLike": {
       "token.actions.githubusercontent.com:sub": "repo:USERNAME/REPO:*"
     }
   }
  }
 ]
}

Replace:
<ACCOUNT_ID> â†’ your AWS account id
USERNAME â†’ your GitHub username
REPO â†’ your repo name


Add Required IAM Permissions to OIDC Role
Go to:
AWS Console â†’ IAM â†’ Roles â†’ github-oidc-selfhosted-role

Click:
Add permissions â†’ Create inline policy

Add This Policy (Minimum Required for Your Error)
Paste this JSON:

{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "kms:CreateKey",
        "kms:TagResource",
        "kms:DescribeKey",
        "kms:CreateAlias",
        "kms:EnableKeyRotation",
        "kms:PutKeyPolicy"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:PutRetentionPolicy",
        "logs:DescribeLogGroups"
      ],
      "Resource": "*"
    }
  ]
}

Save policy.



Example:
repo:KastroVKiran/Jenkins-Terraform-EKS:*
